<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Control de Servicios (En Vivo)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root {
            --font-main: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1b26; --bg-secondary: #24283b; --bg-tertiary: #414868;
            --text-primary: #c0caf5; --text-secondary: #a9b1d6; --accent: #7dcfff;
            --accent-glow: rgba(125, 207, 255, 0.2); --border-color: #3b3f51;
            --success: #9ece6a; --pending: #e0af68; --danger: #f7768e;
            --modal-bg: rgba(36, 40, 59, 0.85);
            --highlight-bg: rgba(125, 207, 255, 0.25);
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef;
            --text-primary: #212529; --text-secondary: #495057; --accent: #007bff;
            --accent-glow: rgba(0, 123, 255, 0.15); --border-color: #dee2e6;
            --success: #28a745; --pending: #ffc107; --danger: #dc3545;
            --modal-bg: rgba(255, 255, 255, 0.85);
            --highlight-bg: rgba(0, 123, 255, 0.15);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-main); margin: 0;
            background-color: var(--bg-primary); color: var(--text-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .container { max-width: 1800px; margin: 0 auto; padding: 1rem 1.5rem; }

        .header-controls {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; background-color: var(--bg-secondary);
            border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);
        }
        .header-controls h1 { margin: 0; font-size: 1.5rem; color: var(--text-primary); font-weight: 600; }
        .action-buttons { display: flex; align-items: center; gap: 1rem; }

        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); transition: var(--transition-speed); border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: var(--transition-speed); border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(24px); }

        .icon-btn {
            background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary);
            padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; gap: 0.5rem; font-weight: 600;
            transition: all var(--transition-speed);
        }
        .icon-btn:hover { color: var(--accent); border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .icon-btn svg { width: 16px; height: 16px; }

        .dashboard {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 1.5rem;
        }
        .kpi-card {
            background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;
            border: 1px solid var(--border-color); border-left: 5px solid var(--accent);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .kpi-card .value { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); }
        .kpi-card .label { font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .kpi-card.success { border-left-color: var(--success); }
        .kpi-card.pending { border-left-color: var(--pending); }
        /* Estilo para el KPI de Monto Total */
        .kpi-card.total-amount { border-left-color: var(--accent); } /* Puedes elegir un color diferente si lo deseas */


        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { margin-top: 0; margin-bottom: 1.5rem; font-size: 1.2rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        
        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem 1.5rem; align-items: flex-end; }
        .filtro-item label { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; display: block; }
        .filtro-item input, .filtro-item select {
            width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 0.9rem; background: var(--bg-tertiary); color: var(--text-primary);
        }
        .filtro-item input:focus, .filtro-item select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

        /* Estilos para el select multiple de vendedores */
        .filtro-item select[multiple] {
            min-height: 80px; /* Suficiente altura para ver varias opciones */
            padding: 0.5rem;
            background-image: none; /* Eliminar flecha si no es necesaria para multiple */
            overflow-y: auto; /* Para cuando haya muchas opciones */
        }
        .filtro-item select[multiple] option {
            padding: 5px 10px;
        }
        .filtro-item select[multiple] option:checked {
            background-color: var(--accent);
            color: var(--bg-secondary);
        }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; position: relative; }
        th .sort-indicator { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); opacity: 0.6; }
        tbody tr:hover { background-color: var(--bg-tertiary); }
        
        @keyframes fadeOutHighlight {
            from { background-color: var(--highlight-bg); }
            to { background-color: transparent; }
        }
        tr.recently-updated {
            animation: fadeOutHighlight 5s ease-out;
        }

        td {
            white-space: nowrap;
            vertical-align: middle;
        }
        
        td.observation-cell {
            white-space: normal;
            min-width: 250px;
            max-width: 350px;
        }

        .results-footer { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; flex-wrap: wrap; gap: 1rem; }
        #results-info { font-size: 0.9rem; color: var(--text-secondary); }
        .pagination-controls button {
            background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary);
            padding: 0.5rem 0.8rem; margin: 0 2px; border-radius: 6px; cursor: pointer; transition: all var(--transition-speed);
        }
        .pagination-controls button:hover:not(:disabled) { color: var(--accent); border-color: var(--accent); }
        .pagination-controls button.active { background-color: var(--accent); color: var(--bg-secondary); border-color: var(--accent); font-weight: bold; }
        .pagination-controls button:disabled { cursor: not-allowed; opacity: 0.5; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-container { background: var(--modal-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 16px; width: 90%; max-width: 700px; padding: 2rem; transform: scale(0.9); transition: transform var(--transition-speed); }
        .modal-overlay.visible .modal-container { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; color: var(--accent); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; }
        .modal-content .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; }
        .modal-content .detail-item strong { display: block; color: var(--text-secondary); margin-bottom: 0.25rem; font-size: 0.875rem; text-transform: uppercase; }
        .modal-content .detail-item span { color: var(--text-primary); font-size: 1rem; }
        .modal-content .full-width { grid-column: 1 / -1; }
        #modal-obs-planificacion { display: block; white-space: pre-wrap; background-color: var(--bg-primary); padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; max-height: 150px; overflow-y: auto; font-style: italic; }

        /* Estilos espec√≠ficos para inputs de fecha */
        [data-theme="dark"] input[type="date"] {
            color-scheme: dark; /* Asegura que el calendario emergente sea oscuro */
        }

        @media (max-width: 992px) {
            .filtros-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
            .table-container { -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .filtros-grid { grid-template-columns: 1fr; }
            th, td { padding: 0.8rem 0.6rem; font-size: 0.85rem; }
            .results-footer { flex-direction: column; align-items: center; }
            .modal-container { width: 95%; padding: 1.5rem; }
        }
        @media (max-width: 600px) {
            .header-controls { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .action-buttons { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <div class="header-controls">
            <h1>Panel de Control (En Vivo)</h1>
            <div class="action-buttons">
                <button class="icon-btn" id="export-csv-btn">
                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 7.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L9 10.586V3a1 1 0 112 0v7.586l2.707-2.707a1 1 0 011.414 0zM4 14a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z"></path></svg>
                    Exportar
                </button>
                <div class="theme-switch-wrapper">
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="kpi-card">
                <div class="value" id="kpi-total">-</div>
                <div class="label">Total Servicios</div>
            </div>
            <div class="kpi-card pending">
                <div class="value" id="kpi-pending">-</div>
                <div class="label">Servicios Pendientes</div>
            </div>
            <div class="kpi-card success">
                <div class="value" id="kpi-confirmed">-</div>
                <div class="label">Servicios Confirmados</div>
            </div>
            <div class="kpi-card total-amount">
                <div class="value" id="kpi-total-amount">-</div>
                <div class="label">Monto Total Servicios</div>
            </div>
        </div>

        <div class="card">
            <h2>Filtros</h2>
            <div class="filtros-grid">
                <div class="filtro-item" style="grid-column: 1 / -1; @media (min-width: 992px) { grid-column: 1 / 3; }">
                    <label for="busqueda">B√∫squeda General</label>
                    <input type="text" id="busqueda" placeholder="Buscar por cliente, req, etc...">
                </div>
                <div class="filtro-item">
                    <label for="filtro-estado">Estado</label>
                    <select id="filtro-estado"><option value="">Todos</option></select>
                </div>
                <div class="filtro-item">
                    <label for="filtro-vendedor">Vendedor(es)</label>
                    <select id="filtro-vendedor" multiple size="3"></select> </div>
                <div class="filtro-item">
                    <label for="filtro-tipo-servicio">Tipo de Servicio</label>
                    <select id="filtro-tipo-servicio">
                        <option value="">Todos</option>
                        <option value="Canal Tradicional">Canal Tradicional</option>
                        <option value="Proyeccion">Proyecci√≥n</option>
                        <option value="Retail Mantencion">Retail Mantenci√≥n</option>
                        <option value="Retail Asistencia">Retail Asistencia</option>
                        <option value="Retail Repuestos">Retail Repuestos</option>
                        <option value="Post Venta">Post Venta</option>
                        <option value="Montaje">Montaje</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtro-fecha-asignada-desde">Fecha Asignada Desde</label>
                    <input type="date" id="filtro-fecha-asignada-desde">
                </div>
                <div class="filtro-item">
                    <label for="filtro-fecha-asignada-hasta">Fecha Asignada Hasta</label>
                    <input type="date" id="filtro-fecha-asignada-hasta">
                </div>
                <div class="filtro-item">
                    <label for="filtro-repuestos">Tiene Repuestos</label>
                    <select id="filtro-repuestos"><option value="">Todos</option><option value="S√≠">S√≠</option><option value="No">No</option></select>
                </div>
                <div class="filtro-item">
                    <label for="filtro-rep-despachados">Rep. Despachados</label>
                    <select id="filtro-rep-despachados"><option value="">Todos</option><option value="S√≠">S√≠</option><option value="No">No</option><option value="Pendiente">Pendiente</option></select>
                </div>
                <div class="filtro-item">
                    <label>&nbsp;</label>
                    <button id="btn-limpiar-filtros" class="icon-btn" style="background-color: var(--danger); color: white; border-color: var(--danger); justify-content: center;">Limpiar</button>
                </div>
            </div>
        </div>

        <div class="card">
             <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th data-sort="numRequerimiento">N¬∫ Req.<span class="sort-indicator"></span></th>
                            <th data-sort="numNV">N¬∫ NV<span class="sort-indicator"></span></th>
                            <th data-sort="cliente">Cliente<span class="sort-indicator"></span></th>
                            <th data-sort="montoServicio">Monto<span class="sort-indicator"></span></th> <th data-sort="tipoServicio">Tipo Servicio<span class="sort-indicator"></span></th> <th data-sort="vendedor">Vendedor<span class="sort-indicator"></span></th>
                            <th data-sort="tieneRepuestos">Tiene Rep.<span class="sort-indicator"></span></th>
                            <th data-sort="repuestosDespachados">Rep. Desp.<span class="sort-indicator"></span></th>
                            <th data-sort="fechaAsignada">F. Asignada<span class="sort-indicator"></span></th>
                            <th data-sort="estado">Estado<span class="sort-indicator"></span></th>
                            <th data-sort="observacionesPlanificacion">Obs. Planif.<span class="sort-indicator"></span></th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-visor-servicios"></tbody>
                </table>
            </div>
            <div class="results-footer">
                <span id="results-info"></span>
                <div id="pagination-controls" class="pagination-controls"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="service-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modal-req-num"></h2>
                <button class="modal-close-btn" id="modal-close">&times;</button>
            </div>
            <div class="modal-content">
                <div class="detail-grid">
                    <div class="detail-item"><strong>Cliente:</strong> <span id="modal-cliente"></span></div>
                    <div class="detail-item"><strong>N¬∫ NV:</strong> <span id="modal-numNV"></span></div>
                    <div class="detail-item full-width"><strong>Direcci√≥n:</strong> <span id="modal-direccion"></span></div>
                    <div class="detail-item"><strong>Vendedor:</strong> <span id="modal-vendedor"></span></div>
                    <div class="detail-item"><strong>Estado Actual:</strong> <span id="modal-estado"></span></div>
                    <div class="detail-item"><strong>Monto Servicio:</strong> <span id="modal-montoServicio"></span></div>
                    <div class="detail-item"><strong>Tipo Servicio:</strong> <span id="modal-tipoServicio"></span></div>
                    <div class="detail-item"><strong>Contacto:</strong> <span id="modal-contacto"></span></div>
                    <div class="detail-item"><strong>Tel√©fono:</strong> <span id="modal-telefono"></span></div>
                    <div class="detail-item"><strong>Tiene Repuestos:</strong> <span id="modal-tieneRepuestos"></span></div>
                    <div class="detail-item"><strong>Repuestos Despachados:</strong> <span id="modal-repDespachados"></span></div>
                    <div class="detail-item"><strong>Fecha Sugerida (Ejec.):</strong> <span id="modal-fecha-programacion"></span></div>
                    <div class="detail-item"><strong>Fecha Asignada (Planif.):</strong> <span id="modal-fecha-asignada"></span></div>
                    <div class="detail-item"><strong>Fecha Creaci√≥n:</strong> <span id="modal-fecha-solicitud"></span></div>
                    <div class="detail-item"><strong>√öltima Edici√≥n:</strong> <span id="modal-fecha-edicion"></span></div>
                    <div class="detail-item full-width"><strong>Info. Servicio:</strong> <span id="modal-info-servicio"></span></div>
                    <div class="detail-item full-width">
                        <strong>üìù Observaciones de Planificaci√≥n:</strong>
                        <span id="modal-obs-planificacion"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA9tUGGmMqk85Hljw8H1XoTfX2U5iQu85c",
          authDomain: "control-de-servicios-b8e34.firebaseapp.com",
          projectId: "control-de-servicios-b8e34",
        };
        const viewerEmail = "visor@maquipan.cl";
        const viewerPassword = "Maquipan2025..";

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Funci√≥n para formatear monto en pesos chilenos para visualizaci√≥n
        function displayCurrency(value) {
            if (value === undefined || value === null || value === '' || isNaN(value)) return 'N/A';
            const numericValue = parseInt(String(value).replace(/\$|\./g, ''), 10); // Limpia y convierte a n√∫mero
            if (isNaN(numericValue)) return 'N/A';
            return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(numericValue);
        }

        const ui = {
            body: document.documentElement,
            tableBody: document.getElementById('tabla-visor-servicios'),
            kpi: { 
                total: document.getElementById('kpi-total'), 
                pending: document.getElementById('kpi-pending'), 
                confirmed: document.getElementById('kpi-confirmed'),
                totalAmount: document.getElementById('kpi-total-amount'), // Nuevo KPI
            },
            modal: {
                overlay: document.getElementById('service-modal'), closeBtn: document.getElementById('modal-close'),
                reqNum: document.getElementById('modal-req-num'), cliente: document.getElementById('modal-cliente'), numNV: document.getElementById('modal-numNV'),
                direccion: document.getElementById('modal-direccion'), vendedor: document.getElementById('modal-vendedor'), estado: document.getElementById('modal-estado'),
                montoServicio: document.getElementById('modal-montoServicio'), // Nuevo en modal
                tipoServicio: document.getElementById('modal-tipoServicio'),   // Nuevo en modal
                contacto: document.getElementById('modal-contacto'), telefono: document.getElementById('modal-telefono'),
                tieneRepuestos: document.getElementById('modal-tieneRepuestos'), repDespachados: document.getElementById('modal-repDespachados'),
                fechaProgramacion: document.getElementById('modal-fecha-programacion'), fechaAsignada: document.getElementById('modal-fecha-asignada'),
                fechaSolicitud: document.getElementById('modal-fecha-solicitud'), fechaEdicion: document.getElementById('modal-fecha-edicion'),
                infoServicio: document.getElementById('modal-info-servicio'), obsPlanificacion: document.getElementById('modal-obs-planificacion'),
            },
            themeToggle: document.getElementById('theme-toggle'),
            exportBtn: document.getElementById('export-csv-btn'),
            filters: {
                busqueda: document.getElementById('busqueda'), estado: document.getElementById('filtro-estado'),
                vendedor: document.getElementById('filtro-vendedor'), 
                tipoServicio: document.getElementById('filtro-tipo-servicio'), // Nuevo filtro
                fechaAsignadaDesde: document.getElementById('filtro-fecha-asignada-desde'), // Nuevo filtro de fecha
                fechaAsignadaHasta: document.getElementById('filtro-fecha-asignada-hasta'), // Nuevo filtro de fecha
                repuestos: document.getElementById('filtro-repuestos'),
                repDespachados: document.getElementById('filtro-rep-despachados'), btnClear: document.getElementById('btn-limpiar-filtros'),
            },
            headers: document.querySelectorAll('th[data-sort]'),
            resultsInfo: document.getElementById('results-info'),
            pagination: document.getElementById('pagination-controls'),
        };

        const state = {
            allServices: [],
            filteredServices: [],
            vendedoresCache: [], // Para almacenar vendedores √∫nicos
            sortConfig: { column: 'timestamp', direction: 'desc' },
            pagination: { currentPage: 1, rowsPerPage: 20 },
            isFirstLoad: true,
        };
        
        async function init() {
            loadPreferences();
            addEventListeners();
            try {
                await auth.signInWithEmailAndPassword(viewerEmail, viewerPassword);
                
                db.collection('servicios').onSnapshot(snapshot => {
                    console.log("Datos recibidos en tiempo real.");
                    state.allServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (state.isFirstLoad) {
                        populateFilters();
                        state.isFirstLoad = false;
                    }
                    
                    applyFiltersAndRender();
                }, error => {
                    console.error("Error al escuchar la base de datos:", error);
                    alert("Se perdi√≥ la conexi√≥n a la base de datos en tiempo real.");
                });

            } catch (error) { console.error("Error en la inicializaci√≥n:", error); alert("No se pudo conectar a la base de datos."); }
        }

        function applyFiltersAndRender() {
            applyFilters();
            applySorting();
            render();
            savePreferences();
        }

        function render() {
            renderDashboard();
            renderTable();
            renderPagination();
            updateSortIndicators();
        }
        
        function applyFilters() {
            const f = ui.filters;
            state.filteredServices = state.allServices.filter(s => {
                const searchStr = f.busqueda.value.toLowerCase();
                const matchSearch = !searchStr || [s.cliente, s.direccion, s.nomContacto, s.numRequerimiento, s.infoServicio, s.numNV, String(s.montoServicio || '').toLowerCase(), String(s.tipoServicio || '').toLowerCase()]
                    .some(val => String(val || '').toLowerCase().includes(searchStr));
                
                // Filtro m√∫ltiple para vendedor
                const selectedVendedores = Array.from(f.vendedor.options)
                                             .filter(option => option.selected && option.value !== '')
                                             .map(option => option.value);
                const matchVendedor = selectedVendedores.length === 0 || (s.vendedor && selectedVendedores.includes(s.vendedor));

                // Filtro para tipo de servicio
                const matchTipoServicio = !f.tipoServicio.value || s.tipoServicio === f.tipoServicio.value;

                // Filtro por rango de fechas asignadas
                let matchFechaAsignada = true;
                const fechaDesde = f.fechaAsignadaDesde.value;
                const fechaHasta = f.fechaAsignadaHasta.value;

                if (s.fechaAsignada) {
                    if (fechaDesde && s.fechaAsignada < fechaDesde) {
                        matchFechaAsignada = false;
                    }
                    if (fechaHasta && s.fechaAsignada > fechaHasta) {
                        matchFechaAsignada = false;
                    }
                } else if (fechaDesde || fechaHasta) { // Si no tiene fecha asignada y hay filtro de fecha, no coincide
                    matchFechaAsignada = false;
                }
                
                return matchSearch &&
                    (!f.estado.value || s.estado === f.estado.value) &&
                    matchVendedor && 
                    matchTipoServicio && 
                    matchFechaAsignada && // Aplicar el filtro de fecha
                    (!f.repuestos.value || s.tieneRepuestos === f.repuestos.value) &&
                    (!f.repDespachados.value || s.repuestosDespachados === f.repDespachados.value);
            });
            if (state.pagination.currentPage > Math.ceil(state.filteredServices.length / state.pagination.rowsPerPage) && state.filteredServices.length > 0) {
                state.pagination.currentPage = 1;
            }
        }

        function applySorting() {
            const { column, direction } = state.sortConfig;
            state.filteredServices.sort((a, b) => {
                let valA = a[column], valB = b[column];

                // Manejo especial para montoServicio para ordenar como n√∫mero
                if (column === 'montoServicio') {
                    valA = parseInt(String(valA || '0').replace(/\$|\./g, ''), 10);
                    valB = parseInt(String(valB || '0').replace(/\$|\./g, ''), 10);
                }
                
                if (column === 'timestamp') { valA = a.fechaEdicion || a.timestamp; valB = b.fechaEdicion || b.timestamp; }
                if (valA?.toDate) valA = valA.toDate(); if (valB?.toDate) valB = valB.toDate();
                if (valA === undefined || valA === null) return 1;
                if (valB === undefined || valB === null) return -1;
                if (typeof valA === 'string' && column !== 'montoServicio') valA = valA.toLowerCase(); // No convertir monto a lowerCase
                if (typeof valB === 'string' && column !== 'montoServicio') valB = valB.toLowerCase(); // No convertir monto a lowerCase
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function renderDashboard() {
            const source = state.filteredServices;
            ui.kpi.total.textContent = source.length;
            ui.kpi.confirmed.textContent = source.filter(s => s.estado === 'Confirmado' || s.estado === 'En Progreso').length;
            ui.kpi.pending.textContent = source.filter(s => s.estado === 'Pendiente').length;
            
            // Calcular y mostrar Monto Total de Servicios
            const totalAmount = source.reduce((sum, s) => sum + (parseInt(String(s.montoServicio || '0').replace(/\$|\./g, ''), 10) || 0), 0);
            ui.kpi.totalAmount.textContent = displayCurrency(totalAmount);
        }

        function renderTable() {
            ui.tableBody.innerHTML = '';
            const { currentPage, rowsPerPage } = state.pagination;
            const pageServices = state.filteredServices.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);

            if (pageServices.length === 0) {
                ui.tableBody.innerHTML = `<tr><td colspan="12" style="text-align:center;">No se encontraron resultados.</td></tr>`; // Aumentado colspan
                return;
            }

            pageServices.forEach(s => {
                const tr = document.createElement('tr');
                
                const lastModified = s.fechaEdicion || s.timestamp;
                if (lastModified?.toDate) {
                    const diffSeconds = (new Date() - lastModified.toDate()) / 1000;
                    if (diffSeconds < 90) { 
                        tr.classList.add('recently-updated');
                    }
                }
                
                const obsFull = s.observacionesPlanificacion || '';
                const obsSnippet = obsFull.length > 35 ? obsFull.substring(0, 35) + '...' : obsFull;

                tr.innerHTML = `
                    <td>${s.numRequerimiento || 'N/A'}</td>
                    <td>${s.numNV || 'N/A'}</td>
                    <td>${s.cliente || 'N/A'}</td>
                    <td>${displayCurrency(s.montoServicio)}</td> <td>${s.tipoServicio || 'N/A'}</td> <td>${s.vendedor ? s.vendedor.split('@')[0] : 'N/A'}</td>
                    <td>${s.tieneRepuestos || 'N/A'}</td>
                    <td>${s.repuestosDespachados || 'N/A'}</td>
                    <td>${formatDateString(s.fechaAsignada)}</td>
                    <td>${s.estado || 'N/A'}</td>
                    <td class="observation-cell" title="${obsFull}">${obsSnippet || 'N/A'}</td>
                    <td><button class="view-details-btn icon-btn" data-id="${s.id}" style="width:100%; justify-content:center;">Ver</button></td>`;

                ui.tableBody.appendChild(tr);
            });
        }

        function renderPagination() {
            ui.pagination.innerHTML = '';
            const totalPages = Math.ceil(state.filteredServices.length / state.pagination.rowsPerPage);
            if (totalPages <= 1) {
                ui.resultsInfo.textContent = `Mostrando ${state.filteredServices.length} resultados.`;
                return;
            }

            const start = (state.pagination.currentPage - 1) * state.pagination.rowsPerPage + 1;
            const end = Math.min(start + state.pagination.rowsPerPage - 1, state.filteredServices.length);
            ui.resultsInfo.textContent = `Mostrando ${start}-${end} de ${state.filteredServices.length} resultados.`;

            const createButton = (text, page, isDisabled = false, isActive = false) => {
                const button = document.createElement('button');
                button.innerHTML = text; button.disabled = isDisabled;
                if (isActive) button.classList.add('active');
                button.addEventListener('click', () => { state.pagination.currentPage = page; render(); savePreferences(); });
                return button;
            };
            ui.pagination.appendChild(createButton('‚Äπ', state.pagination.currentPage - 1, state.pagination.currentPage === 1));
            let pages = [];
            if(totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) pages.push(i);
            } else {
                pages = [1, 2];
                let startPage = Math.max(3, state.pagination.currentPage - 1);
                let endPage = Math.min(totalPages - 2, state.pagination.currentPage + 1);
                if (state.pagination.currentPage > 3) pages.push('...');
                for (let i = startPage; i <= endPage; i++) pages.push(i);
                if (state.pagination.currentPage < totalPages - 2) pages.push('...');
                pages.push(totalPages - 1, totalPages);
            }

            pages.forEach(p => {
                if(typeof p === 'number') ui.pagination.appendChild(createButton(p, p, false, p === state.pagination.currentPage));
                else { const span = document.createElement('span'); span.textContent = '...'; span.style.padding = '0.5rem'; ui.pagination.appendChild(span); }
            });
            ui.pagination.appendChild(createButton('‚Ä∫', state.pagination.currentPage + 1, state.pagination.currentPage === totalPages));
        }
        
        function updateSortIndicators() {
            ui.headers.forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                if (indicator) {
                    // El sort por 'timestamp' no tiene columna visible, por lo que su indicador no es necesario
                    indicator.textContent = header.dataset.sort === state.sortConfig.column ? (state.sortConfig.direction === 'asc' ? '‚ñ≤' : '‚ñº') : '';
                }
            });
        }
        
        function populateFilters() {
            // Populate Estado filter (existing logic)
            const getUniqueStates = [...new Set(state.allServices.map(s => s.estado).filter(Boolean))].sort();
            const currentEstado = ui.filters.estado.value;
            ui.filters.estado.innerHTML = '<option value="">Todos</option>';
            getUniqueStates.forEach(val => ui.filters.estado.add(new Option(val, val)));
            ui.filters.estado.value = currentEstado;

            // Populate Vendedor filter (now multiple select)
            state.vendedoresCache = [...new Set(state.allServices.map(s => s.vendedor).filter(Boolean))].sort();
            const currentSelectedVendedores = Array.from(ui.filters.vendedor.options).filter(opt => opt.selected).map(opt => opt.value);
            ui.filters.vendedor.innerHTML = ''; // Clear existing options
            
            state.vendedoresCache.forEach(vendedor => {
                const option = new Option(vendedor.split('@')[0], vendedor);
                option.selected = currentSelectedVendedores.includes(vendedor); // Re-select previously chosen ones
                ui.filters.vendedor.add(option);
            });

            // Populate Tipo de Servicio filter
            const tiposDeServicio = [
                "Canal Tradicional", "Proyeccion", "Retail Mantencion",
                "Retail Asistencia", "Retail Repuestos", "Post Venta", "Montaje"
            ];
            const currentTipoServicio = ui.filters.tipoServicio.value;
            ui.filters.tipoServicio.innerHTML = '<option value="">Todos</option>';
            tiposDeServicio.forEach(val => ui.filters.tipoServicio.add(new Option(val, val)));
            ui.filters.tipoServicio.value = currentTipoServicio;

            // Populate Fecha Asignada Desde/Hasta (no din√°mico, solo mantener valores)
            // Values are loaded via loadPreferences() directly into the input fields.
        }

        function openModal(service) {
            ui.modal.reqNum.textContent = `Detalles: Req #${service.numRequerimiento || 'N/A'}`;
            // Mapea directamente los campos existentes y sus IDs en el modal
            ui.modal.cliente.textContent = service.cliente || 'N/A';
            ui.modal.numNV.textContent = service.numNV || 'N/A';
            ui.modal.direccion.textContent = service.direccion || 'N/A';
            ui.modal.vendedor.textContent = service.vendedor ? service.vendedor.split('@')[0] : 'N/A';
            ui.modal.estado.textContent = service.estado || 'N/A';
            
            // Nuevos campos del modal
            ui.modal.montoServicio.textContent = displayCurrency(service.montoServicio);
            ui.modal.tipoServicio.textContent = service.tipoServicio || 'N/A';

            ui.modal.contacto.textContent = service.nomContacto || 'N/A';
            ui.modal.telefono.textContent = service.numContacto || 'N/A';
            ui.modal.tieneRepuestos.textContent = service.tieneRepuestos || 'N/A';
            ui.modal.repDespachados.textContent = service.tieneRepuestos === 'S√≠' ? (service.repuestosDespachados || 'Pendiente') : 'N/A';
            ui.modal.fechaProgramacion.textContent = formatDateString(service.fechaProgramacion);
            ui.modal.fechaAsignada.textContent = formatDateString(service.fechaAsignada);
            ui.modal.fechaSolicitud.textContent = formatTimestamp(service.timestamp);
            ui.modal.fechaEdicion.textContent = service.fechaEdicion ? formatTimestamp(service.fechaEdicion) : 'Sin ediciones';
            ui.modal.infoServicio.textContent = service.infoServicio || 'N/A';
            ui.modal.obsPlanificacion.textContent = service.observacionesPlanificacion || 'Sin observaciones.';
            ui.modal.overlay.classList.add('visible');
        }

        function closeModal() { ui.modal.overlay.classList.remove('visible'); }
        function formatTimestamp(ts) { if(!ts?.toDate) return 'N/A'; const d=ts.toDate(); return `${d.toLocaleDateString('es-CL')} ${d.toLocaleTimeString('es-CL')}`; }
        function formatDateString(dateStr) {
            if (!dateStr || dateStr === 'N/A') return 'N/A';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function savePreferences() {
            const selectedVendedores = Array.from(ui.filters.vendedor.options)
                                             .filter(option => option.selected)
                                             .map(option => option.value);
            
            const prefs = {
                filters: {
                    busqueda: ui.filters.busqueda.value, 
                    estado: ui.filters.estado.value, 
                    vendedor: selectedVendedores, // Guardar array de vendedores seleccionados
                    tipoServicio: ui.filters.tipoServicio.value, 
                    fechaAsignadaDesde: ui.filters.fechaAsignadaDesde.value, // Guardar fecha desde
                    fechaAsignadaHasta: ui.filters.fechaAsignadaHasta.value, // Guardar fecha hasta
                    repuestos: ui.filters.repuestos.value, 
                    repDespachados: ui.filters.repDespachados.value,
                }, 
                sortConfig: state.sortConfig, 
                pagination: { currentPage: state.pagination.currentPage }
            };
            localStorage.setItem('visorPrefs', JSON.stringify(prefs));
        }

        function loadPreferences() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            ui.body.setAttribute('data-theme', savedTheme);
            ui.themeToggle.checked = savedTheme === 'dark';
            const savedPrefs = JSON.parse(localStorage.getItem('visorPrefs'));
            if (savedPrefs) {
                // Load single-value filters
                ['busqueda', 'estado', 'tipoServicio', 'repuestos', 'repDespachados', 'fechaAsignadaDesde', 'fechaAsignadaHasta'].forEach(key => { 
                    if(ui.filters[key] && savedPrefs.filters[key] !== undefined) ui.filters[key].value = savedPrefs.filters[key]; 
                });
                
                // Load multiple-select for vendedores: Handled by populateFilters() after options are loaded
                // The values are stored in savedPrefs.filters.vendedor as an array.
                // populateFilters will check this array against its options.
                if (savedPrefs.filters.vendedor && Array.isArray(savedPrefs.filters.vendedor)) {
                    // Temporarily store selected values until options are populated
                    ui.filters.vendedor.dataset.preselected = JSON.stringify(savedPrefs.filters.vendedor);
                }

                state.sortConfig = savedPrefs.sortConfig;
                state.pagination.currentPage = savedPrefs.pagination.currentPage;
            }
        }
        
        function exportToCSV() {
            const headers = ["N¬∫ Requerimiento", "N¬∫ NV", "Cliente", "Monto Servicio", "Tipo Servicio", "Vendedor", "Tiene Repuestos", "Repuestos Despachados", "Fecha Sugerida", "Fecha Asignada", "Fecha Creaci√≥n/Solicitud", "Fecha √öltima Edici√≥n", "Estado", "Observaciones Planificaci√≥n", "Info. Servicio", "Direcci√≥n", "Contacto", "Tel√©fono"]; // Actualizados
            const rows = state.filteredServices.map(s => [
                s.numRequerimiento, 
                s.numNV, 
                s.cliente, 
                displayCurrency(s.montoServicio), // Formateado para CSV
                s.tipoServicio, 
                s.vendedor, 
                s.tieneRepuestos, 
                s.repuestosDespachados, 
                s.fechaProgramacion, 
                s.fechaAsignada, 
                formatTimestamp(s.timestamp), 
                s.fechaEdicion ? formatTimestamp(s.fechaEdicion) : '', 
                s.estado, 
                s.observacionesPlanificacion, 
                s.infoServicio, 
                s.direccion, 
                s.nomContacto, 
                s.numContacto
            ].map(val => `"${String(val || '').replace(/"/g, '""')}"`));
            
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `reporte_servicios_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function addEventListeners() {
            // General filter change listener (for single-value selects and text input)
            ['busqueda', 'estado', 'tipoServicio', 'repuestos', 'repDespachados', 'fechaAsignadaDesde', 'fechaAsignadaHasta'].forEach(id => { // Se a√±aden los nuevos filtros de fecha
                ui.filters[id].addEventListener('input', () => { 
                    state.pagination.currentPage = 1; 
                    applyFiltersAndRender(); 
                });
            });

            // Specific listener for multi-select vendedor filter
            ui.filters.vendedor.addEventListener('change', () => {
                state.pagination.currentPage = 1;
                applyFiltersAndRender();
            });

            ui.filters.btnClear.addEventListener('click', () => { 
                ui.filters.busqueda.value = '';
                ui.filters.estado.value = '';
                // Clear all selected options in multiple select
                Array.from(ui.filters.vendedor.options).forEach(option => {
                    option.selected = false;
                });
                ui.filters.tipoServicio.value = '';
                ui.filters.fechaAsignadaDesde.value = ''; // Limpiar campo fecha desde
                ui.filters.fechaAsignadaHasta.value = ''; // Limpiar campo fecha hasta
                ui.filters.repuestos.value = '';
                ui.filters.repDespachados.value = '';
                applyFiltersAndRender(); 
            });

            ui.headers.forEach(header => header.addEventListener('click', () => {
                const newColumn = header.dataset.sort;
                if (!newColumn) return;
                state.sortConfig.direction = (state.sortConfig.column === newColumn && state.sortConfig.direction === 'desc') ? 'asc' : 'desc';
                state.sortConfig.column = newColumn;
                applyFiltersAndRender();
            }));
            ui.themeToggle.addEventListener('change', (e) => { ui.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light'); localStorage.setItem('theme', e.target.checked ? 'dark' : 'light'); });
            ui.exportBtn.addEventListener('click', exportToCSV);
            ui.tableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.view-details-btn');
                if (btn) {
                    const service = state.allServices.find(s => s.id === btn.dataset.id);
                    if (service) openModal(service);
                }
            });
            ui.modal.closeBtn.addEventListener('click', closeModal);
            ui.modal.overlay.addEventListener('click', (e) => { if (e.target === ui.modal.overlay) closeModal(); });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
